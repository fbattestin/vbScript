' Before we can start youâ€™ll need to add a reference to your VBA project:
' Microsoft ActiveX Data Objects x.x Library

Option Explicit
Private Conn As ADODB.Connection

Function ConnectToDB(Server As String, Database As String) As Boolean
 
    Set Conn = New ADODB.Connection
    On Error Resume Next
    
    Server = Worksheets("CONN").Cells(1, "B").Value
    Database = Worksheets("CONN").Cells(2, "B").Value
    
    Conn.ConnectionString = "Provider=SQLOLEDB.1; Integrated Security=SSPI; Server=" & Server & "; Database=" & Database & ";"
    Conn.Open
    
    If Conn.State = 0 Then
        ConnectToDB = False
    Else
        ConnectToDB = True
    End If
 
End Function

Function Query(SQL As String)
 
    Dim recordSet As ADODB.recordSet
    Dim Field As ADODB.Field
 
    Dim Col As Long

    Set recordSet = New ADODB.recordSet
    recordSet.Open SQL, Conn, adOpenStatic, adLockReadOnly, adCmdText
 
    If recordSet.State Then
        Col = 1
        For Each Field In recordSet.Fields
            'ADD COLUMNS
            Worksheets("DATABASE").Cells(1, Col) = Field.Name
            Col = Col + 1
        Next Field
        
        Worksheets("DATABASE").Cells(2, 1).CopyFromRecordset recordSet
        Set recordSet = Nothing
    End If
    
    Call Run
    
End Function

Public Sub Run()
 
    Dim SQL As String
    Dim Connected As Boolean
    Dim qtdExec As Long
    Dim cntCol As Long
    
    Connected = ConnectToDB("SQL_SERVER", "DB_Name")
    qtdExec = Worksheets("QUERY").Cells(1, "F").Value
    cntCol = 1

    If cntCol <= (qtdExec) Then
        SQL = Worksheets("QUERY").Cells(cntCol, "B").Value
        cntCol = cntCol + 1
        If Connected Then
            Call Query(SQL)
        Else
            MsgBox "Huston we have a problem!"
        End If
   
    End If
    Conn.Close
End Sub

